name: Ingress server - push tag
on:
  push:
    tags:
      - ingress-server/*.*.*
jobs:
  get-version:
    name: Get version from tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Get version from tag
        id: get-version
        run: |
          version=$(echo "${{ github.ref_name }}" | cut -d'/' -f2)
          echo "version=$version" >> $GITHUB_OUTPUT
  build-and-deploy:
    name: Build and deploy ingress server for production
    uses: ./.github/workflows/ingress-server-reusable-workflow.yaml
    needs:
      - get-version
    if: needs.get-version.outputs.version != ''
    concurrency:
      group: "${{ github.workflow }}-${{ github.ref }}-build-and-deploy"
      cancel-in-progress: true
    with:
      push-container: true
      deploy-helm-chart: true
      tag: ${{ needs.get-version.outputs.version }}
      namespace: ingress-server
      extra-helm-values: |
        --values .github/values/ingress-server/tag.yaml
    secrets: inherit
