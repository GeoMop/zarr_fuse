FROM docker.io/library/python:3.11-slim

ARG APP_VERSION="devel"

LABEL org.opencontainers.image.title="ZarrFuse Ingress (Backend-only)"
LABEL org.opencontainers.image.description="Flask service for CSV/JSON ingestion into an S3-backed Zarr store (no UI)."
LABEL org.opencontainers.image.version="${APP_VERSION}"
LABEL org.opencontainers.image.licenses="BSD-3-Clause"
LABEL org.opencontainers.image.source="https://github.com/geomop/zarr_fuse"
LABEL org.opencontainers.image.url="https://github.com/geomop/zarr_fuse"
LABEL org.opencontainers.image.authors="Geomop / Stepan Moc <stepan.mocik@gmail.com>"
LABEL maintainer="Geomop / Stepan Moc <stepan.mocik@gmail.com>"

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PIP_NO_CACHE_DIR=1

RUN groupadd -r ingress && useradd -r -g ingress -u 11233 -m -d /ingress-server ingress

WORKDIR /ingress-server

WORKDIR /ingress-server
COPY --chown=ingress:ingress pyproject.toml ./
COPY --chown=ingress:ingress src/ ./src

RUN pip install --upgrade pip setuptools wheel && pip install .

USER ingress

EXPOSE 8000
CMD ["python", "src/main.py"]
